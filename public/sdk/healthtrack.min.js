"use strict";var HealthTrackModule=(()=>{var p=Object.defineProperty,R=Object.defineProperties,D=Object.getOwnPropertyDescriptor,O=Object.getOwnPropertyDescriptors,L=Object.getOwnPropertyNames,y=Object.getOwnPropertySymbols;var _=Object.prototype.hasOwnProperty,M=Object.prototype.propertyIsEnumerable;var P=(s,e,t)=>e in s?p(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,g=(s,e)=>{for(var t in e||(e={}))_.call(e,t)&&P(s,t,e[t]);if(y)for(var t of y(e))M.call(e,t)&&P(s,t,e[t]);return s},v=(s,e)=>R(s,O(e));var U=(s,e)=>{for(var t in e)p(s,t,{get:e[t],enumerable:!0})},x=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of L(e))!_.call(s,i)&&i!==t&&p(s,i,{get:()=>e[i],enumerable:!(n=D(e,i))||n.enumerable});return s};var z=s=>x(p({},"__esModule",{value:!0}),s);var S=(s,e,t)=>new Promise((n,i)=>{var a=r=>{try{o(t.next(r))}catch(u){i(u)}},c=r=>{try{o(t.throw(r))}catch(u){i(u)}},o=r=>r.done?n(r.value):Promise.resolve(r.value).then(a,c);o((t=t.apply(s,e)).next())});var F={};U(F,{HealthTrack:()=>H,HealthTrackSDK:()=>f,consentManager:()=>d,phiDetector:()=>l});var I=/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,E=/(\+?1[-.\s]?)?(\(?\d{3}\)?[-.\s]?)?\d{3}[-.\s]?\d{4}/g,A=/\d{3}[-\s]?\d{2}[-\s]?\d{4}/g,T=/\b(0?[1-9]|1[0-2])[\/\-](0?[1-9]|[12]\d|3[01])[\/\-](19|20)\d{2}\b/g,N=["email","e-mail","mail","phone","telephone","tel","mobile","cell","name","firstName","first_name","lastname","lastName","last_name","fullName","full_name","patientName","patient_name","patient","ssn","socialSecurity","social_security","dob","dateOfBirth","date_of_birth","birthDate","birth_date","birthday","address","street","city","state","zip","zipCode","zip_code","postalCode","postal_code","medicalRecord","medical_record","mrn","diagnosis","condition","treatment","prescription","insurance","insuranceId","insurance_id","memberId","member_id","policyNumber","policy_number"],Q=["email","name","phone","patient","ssn","dob","firstName","lastName","first_name","last_name","gclid","fbclid","msclkid","ttclid","li_fat_id","wbraid","gbraid"],b=class{constructor(){this.debugMode=!1;this.sensitivePagePatterns=[]}setDebugMode(e){this.debugMode=e}configureSensitivePages(e){this.sensitivePagePatterns=e}addSensitivePagePattern(e,t="strip"){this.sensitivePagePatterns.push({pattern:e,action:t})}isSensitivePage(e){for(let{pattern:t,action:n}of this.sensitivePagePatterns)if((typeof t=="string"?new RegExp(t,"i"):t).test(e))return{isSensitive:!0,action:n};return{isSensitive:!1,action:null}}detectPHIInValue(e){return typeof e!="string"?{hasPHI:!1,type:null}:I.test(e)?(I.lastIndex=0,{hasPHI:!0,type:"email"}):E.test(e)?(E.lastIndex=0,{hasPHI:!0,type:"phone"}):A.test(e)?(A.lastIndex=0,{hasPHI:!0,type:"ssn"}):T.test(e)?(T.lastIndex=0,{hasPHI:!0,type:"dob"}):{hasPHI:!1,type:null}}isPHIFieldName(e){let t=e.toLowerCase();return N.some(n=>t.includes(n.toLowerCase()))}scrubObject(e,t=""){let n=[],i={};for(let[a,c]of Object.entries(e)){let o=t?`${t}.${a}`:a;if(this.isPHIFieldName(a)){n.push(o),this.warn(`PHI field detected: ${o}`),i[a]="[REDACTED]";continue}if(typeof c=="string"){let{hasPHI:r,type:u}=this.detectPHIInValue(c);if(r){n.push(`${o} (${u})`),this.warn(`PHI pattern detected in ${o}: ${u}`),i[a]="[REDACTED]";continue}}if(c&&typeof c=="object"&&!Array.isArray(c)){let r=this.scrubObject(c,o);i[a]=r.scrubbedData,n.push(...r.detectedFields);continue}if(Array.isArray(c)){i[a]=c.map((r,u)=>{if(r&&typeof r=="object"){let h=this.scrubObject(r,`${o}[${u}]`);return n.push(...h.detectedFields),h.scrubbedData}return r});continue}i[a]=c}return{hasPHI:n.length>0,detectedFields:n,scrubbedData:i}}scrubUrl(e){if(!e)return"";try{let t=new URL(e);for(let n of Q)t.searchParams.delete(n);for(let[n,i]of t.searchParams.entries()){let{hasPHI:a}=this.detectPHIInValue(i);a&&(this.warn(`PHI detected in URL param: ${n}`),t.searchParams.delete(n))}return t.toString()}catch(t){return e}}stripClickIds(e){if(!e)return"";try{let t=new URL(e),n=["gclid","fbclid","msclkid","ttclid","li_fat_id","wbraid","gbraid"];for(let i of n)t.searchParams.delete(i);return t.toString()}catch(t){return e}}getDefaultHealthcarePatterns(){return[{pattern:/intake[-_]?form/i,action:"block"},{pattern:/appointment/i,action:"strip"},{pattern:/patient[-_]?portal/i,action:"block"},{pattern:/medical[-_]?record/i,action:"block"},{pattern:/prescription/i,action:"block"},{pattern:/health[-_]?history/i,action:"block"},{pattern:/symptom/i,action:"strip"},{pattern:/diagnosis/i,action:"block"},{pattern:/treatment/i,action:"strip"},{pattern:/insurance/i,action:"strip"},{pattern:/billing/i,action:"strip"},{pattern:/contact[-_]?us/i,action:"strip"}]}warn(e){this.debugMode&&console.warn(`[HealthTrack PHI] ${e}`)}},l=new b;var C=class{constructor(){this.adapters=[];this.activeAdapter=null;this.manualConsent=null;this.callbacks=[];this.debugMode=!1;this.adapters=[new k,new m,new w]}setDebugMode(e){this.debugMode=e}init(){for(let e of this.adapters)if(e.isPresent()){this.activeAdapter=e,this.log("info",`CMP detected: ${e.name}`),e.onConsentChange(t=>{this.notifyCallbacks(t)});break}this.activeAdapter||this.log("info","No CMP detected, using default consent")}registerAdapter(e){this.adapters.unshift(e),this.log("info",`Custom CMP adapter registered: ${e.name}`)}setConsent(e){var t,n;this.manualConsent={analytics:(t=e.analytics)!=null?t:!0,marketing:(n=e.marketing)!=null?n:!0},this.log("info","Manual consent set",this.manualConsent),this.notifyCallbacks(this.manualConsent)}getConsent(){return this.manualConsent?g({},this.manualConsent):this.activeAdapter?this.activeAdapter.getConsent():{analytics:!0,marketing:!0}}onConsentChange(e){this.callbacks.push(e)}hasAnyConsent(){let e=this.getConsent();return e.analytics||e.marketing}hasAnalyticsConsent(){return this.getConsent().analytics}hasMarketingConsent(){return this.getConsent().marketing}notifyCallbacks(e){for(let t of this.callbacks)try{t(e)}catch(n){this.log("error","Consent callback error",n)}}log(e,t,n){if(!this.debugMode)return;let i="[HealthTrack Consent]";switch(e){case"info":console.log(i,t,n||"");break;case"warn":console.warn(i,t,n||"");break;case"error":console.error(i,t,n||"");break}}},k=class{constructor(){this.name="Google Consent Mode v2";this.callbacks=[]}isPresent(){return typeof window=="undefined"?!1:Array.isArray(window.dataLayer)}getConsent(){let e=this.getGoogleConsentState();return{analytics:e.analytics_storage==="granted",marketing:e.ad_storage==="granted"||e.ad_user_data==="granted"}}onConsentChange(e){if(this.callbacks.push(e),typeof window=="undefined")return;let t=window;if(!t.dataLayer)return;let n=t.dataLayer.push.bind(t.dataLayer);t.dataLayer.push=(...i)=>{let a=n(...i);for(let c of i)if(this.isConsentUpdate(c)){let o=this.getConsent();this.callbacks.forEach(r=>r(o))}return a}}getGoogleConsentState(){if(typeof window=="undefined")return{};let e=window;if(!e.dataLayer)return{};let t={};for(let n of e.dataLayer)this.isConsentCommand(n)&&Object.assign(t,n[2]);return t}isConsentCommand(e){return Array.isArray(e)&&e[0]==="consent"&&(e[1]==="default"||e[1]==="update")}isConsentUpdate(e){return Array.isArray(e)&&e[0]==="consent"&&e[1]==="update"}},m=class{constructor(){this.name="OneTrust";this.callbacks=[]}isPresent(){if(typeof window=="undefined")return!1;let e=window;return!!(e.OneTrust||e.OptanonActiveGroups||this.getOptanonCookie())}getConsent(){let e=this.getActiveGroups();return{analytics:e.includes("C0002"),marketing:e.includes("C0004")}}onConsentChange(e){var n;if(this.callbacks.push(e),typeof window=="undefined")return;let t=window;(n=t.OneTrust)!=null&&n.OnConsentChanged&&t.OneTrust.OnConsentChanged(()=>{let i=this.getConsent();this.callbacks.forEach(a=>a(i))})}getActiveGroups(){if(typeof window=="undefined")return"";let e=window;return e.OptanonActiveGroups?e.OptanonActiveGroups:this.getOptanonCookie()||""}getOptanonCookie(){if(typeof document=="undefined"||typeof document.cookie!="string")return null;let e=document.cookie.match(/OptanonConsent=([^;]+)/);if(!e)return null;try{let n=decodeURIComponent(e[1]).match(/groups=([^&]+)/);return n?n[1]:null}catch(t){return null}}},w=class{constructor(){this.name="Cookiebot";this.callbacks=[]}isPresent(){if(typeof window=="undefined")return!1;let e=window;return!!(e.Cookiebot||e.CookieConsent)}getConsent(){var t,n;let e=this.getCookieConsent();return{analytics:(t=e==null?void 0:e.statistics)!=null?t:!1,marketing:(n=e==null?void 0:e.marketing)!=null?n:!1}}onConsentChange(e){this.callbacks.push(e),typeof window!="undefined"&&(window.addEventListener("CookiebotOnAccept",()=>{let t=this.getConsent();this.callbacks.forEach(n=>n(t))}),window.addEventListener("CookiebotOnDecline",()=>{let t=this.getConsent();this.callbacks.forEach(n=>n(t))}))}getCookieConsent(){var t;if(typeof window=="undefined")return null;let e=window;return((t=e.Cookiebot)==null?void 0:t.consent)||e.CookieConsent||null}},d=new C;var f=class{constructor(){this.config=null;this.eventQueue=[];this.pendingQueue=[];this.sessionId="";this.initialized=!1;this.batchTimer=null;this.SDK_VERSION="1.0.0";this.DEFAULT_SERVER_URL="/api/v1/events";this.DEFAULT_BATCH_SIZE=10;this.DEFAULT_BATCH_INTERVAL=5e3}init(e){if(this.initialized){this.log("warn","HealthTrack already initialized");return}if(!e.apiKey){this.log("error","API key is required");return}this.config=v(g({},e),{serverUrl:e.serverUrl||this.DEFAULT_SERVER_URL,batchSize:e.batchSize||this.DEFAULT_BATCH_SIZE,batchInterval:e.batchInterval||this.DEFAULT_BATCH_INTERVAL}),l.setDebugMode(e.debug||!1),d.setDebugMode(e.debug||!1),d.init(),d.onConsentChange(t=>{this.log("info","Consent changed",t),(t.analytics||t.marketing)&&this.flushPendingEvents()}),this.sessionId=this.getOrCreateSessionId(),this.initialized=!0,this.startBatchTimer(),this.setupUnloadHandler(),this.trackPageView(),this.log("info","HealthTrack initialized",{sessionId:this.sessionId})}configureSensitivePages(e){l.configureSensitivePages(e),this.log("info","Sensitive page patterns configured",{count:e.length})}addSensitivePagePattern(e,t="strip"){l.addSensitivePagePattern(e,t),this.log("info","Sensitive page pattern added",{pattern:e.toString(),action:t})}loadDefaultHealthcarePatterns(){let e=l.getDefaultHealthcarePatterns();l.configureSensitivePages(e),this.log("info","Default healthcare patterns loaded",{count:e.length})}trackPageView(e){if(!this.checkInitialized())return;let{isSensitive:t,action:n}=l.isSensitivePage(window.location.href);if(t&&n==="block"){this.log("info","Page view blocked - sensitive page");return}let i=this.createEvent("page_view","page_view",e);this.queueEvent(i)}trackEvent(e,t){if(!this.checkInitialized())return;let n=this.createEvent("custom_event",e,t);this.queueEvent(n)}trackConversion(e,t,n){if(!this.checkInitialized())return;let i=this.createEvent("conversion",e,v(g({},n),{conversion_value:t}));this.queueEvent(i)}identify(e){if(!this.checkInitialized())return;let t=this.hashString(e);this.sessionId=t;try{sessionStorage.setItem("ht_user_id",t)}catch(n){}this.log("info","User identified",{hashedId:t.substring(0,8)+"..."})}setConsent(e){d.setConsent(e),this.log("info","Consent updated",e),(e.analytics||e.marketing)&&(this.flushPendingEvents(),this.flushEvents())}getConsent(){return d.getConsent()}registerCMPAdapter(e){d.registerAdapter(e),this.log("info","Custom CMP adapter registered",{name:e.name})}flush(){return this.flushEvents()}checkInitialized(){return this.initialized?!0:(this.log("warn","HealthTrack not initialized. Call HealthTrack.init() first."),!1)}createEvent(e,t,n){let i=n||{},a=[];if(n&&Object.keys(n).length>0){let h=l.scrubObject(n);i=h.scrubbedData,a=h.detectedFields}let{isSensitive:c}=l.isSensitivePage(window.location.href),o=l.scrubUrl(window.location.href),r=l.scrubUrl(document.referrer);c&&(o=l.stripClickIds(o),r=l.stripClickIds(r));let u={event_type:e,event_name:t,properties:i,timestamp:new Date().toISOString(),anonymized_session_id:this.sessionId,page_url:o,referrer:r,sdk_version:this.SDK_VERSION};return a.length>0&&(u.phi_scrubbed=a),u}queueEvent(e){var n;let t=d.getConsent();if(!t.analytics&&!t.marketing){this.pendingQueue.push(e),this.log("info","Event queued pending consent",{type:e.event_type,name:e.event_name});return}this.eventQueue.push(e),this.log("info","Event queued",{type:e.event_type,name:e.event_name}),this.eventQueue.length>=(((n=this.config)==null?void 0:n.batchSize)||this.DEFAULT_BATCH_SIZE)&&this.flushEvents()}flushPendingEvents(){var e;this.pendingQueue.length!==0&&(this.log("info","Flushing pending events",{count:this.pendingQueue.length}),this.eventQueue.push(...this.pendingQueue),this.pendingQueue=[],this.eventQueue.length>=(((e=this.config)==null?void 0:e.batchSize)||this.DEFAULT_BATCH_SIZE)&&this.flushEvents())}flushEvents(){return S(this,null,function*(){if(this.eventQueue.length===0||!this.config)return;let e=[...this.eventQueue];this.eventQueue=[];try{let t=yield fetch(this.config.serverUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:this.config.apiKey,events:e,consent:d.getConsent()})});t.ok?this.log("info","Events sent successfully",{count:e.length}):(this.eventQueue=[...e,...this.eventQueue],this.log("error","Failed to send events",{status:t.status}))}catch(t){this.eventQueue=[...e,...this.eventQueue],this.log("error","Error sending events",{error:t})}})}startBatchTimer(){var e;this.batchTimer||(this.batchTimer=setInterval(()=>{this.flushEvents()},((e=this.config)==null?void 0:e.batchInterval)||this.DEFAULT_BATCH_INTERVAL))}setupUnloadHandler(){let e=()=>{if(this.eventQueue.length===0||!this.config)return;let t=JSON.stringify({apiKey:this.config.apiKey,events:this.eventQueue,consent:d.getConsent()});try{navigator.sendBeacon(this.config.serverUrl,t),this.log("info","Events sent via beacon",{count:this.eventQueue.length})}catch(n){this.log("warn","Beacon failed, events may be lost")}};window.addEventListener("beforeunload",e),window.addEventListener("pagehide",e)}getOrCreateSessionId(){try{let e=sessionStorage.getItem("ht_user_id");if(e)return e;let t=sessionStorage.getItem("ht_session_id");if(t)return t;let n=this.generateSessionId();return sessionStorage.setItem("ht_session_id",n),n}catch(e){return this.generateSessionId()}}generateSessionId(){let e=new Uint8Array(16);return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("")}hashString(e){let t=0;for(let n=0;n<e.length;n++){let i=e.charCodeAt(n);t=(t<<5)-t+i,t=t&t}return"user_"+Math.abs(t).toString(16)}log(e,t,n){var a;if(!((a=this.config)!=null&&a.debug))return;let i="[HealthTrack]";switch(e){case"info":console.log(i,t,n||"");break;case"warn":console.warn(i,t,n||"");break;case"error":console.error(i,t,n||"");break}}},H=new f;typeof window!="undefined"&&(window.HealthTrack=H);return z(F);})();
// HealthTrack Pro SDK v1.0.0 - HIPAA Compliant Tracking
